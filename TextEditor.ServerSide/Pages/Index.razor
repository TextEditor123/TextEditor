@page "/"
@using TextEditor.ServerSide.Lists
@using TextEditor.ServerSide.TextEditors

<PageTitle>Index</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<SurveyPrompt Title="How is Blazor working for you?" />

<button class="btn btn-primary" @onclick="AddRandomPersonToListOnClick">Add random Person to List</button>

<ListComponent @ref="_listComponent" TItem="Person" />

@{
    // I believe this is the correct syntax, but I'm uncertain
    _personRenderFragment = person =>
    @<text>
        @person.FirstName @person.LastName
    </text>;
}

@code {
    [Inject]
    private IJSRuntime JS { get; set; } = null!;

    private ListComponent<Person>? _listComponent;
    private List<Person> _personList = new();
    private RenderFragment<Person>? _personRenderFragment;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (_listComponent is null)
            {
                throw new NotImplementedException("I'm not sure the best approach to this nullable reference type warning");
            }

            await _listComponent.InitializeAsync(
                (skip, take) => _personList.Skip(skip).Take(take),
                _personList.Count,
                ButtonsProvider,
                _personRenderFragment,
                async (eventKind, person, dataButton) =>
                {
                    switch (eventKind)
                    {
                        case ListComponentEventKind.Click:
                            if (!string.IsNullOrWhiteSpace(dataButton))
                            {
                                await JS.InvokeVoidAsync("alert", dataButton);
                            }
                            break;
                        case ListComponentEventKind.Delete:
                            _personList.Remove(person);
                            await (_listComponent?.SetTotalCountAsync(_personList.Count) ?? Task.CompletedTask);
                            return;
                        case ListComponentEventKind.Enter:
                            if (!string.IsNullOrWhiteSpace(dataButton))
                            {
                                await JS.InvokeVoidAsync("alert", dataButton);
                            }
                            break;
                    }
                }/*,
                itemHeightOverride: 500*/);
        }
        // The base for 'OnAfterRenderAsync' does nothing, thus you don't need to include it anywhere.
    }

    private IEnumerable<(string CssClass, string DataButton, string Text)> ButtonsProvider(Person person)
    {
        yield return ("btn btn-danger", "delete", "Delete");
        yield return ("btn btn-info", "view", "View");
    }

    private Task AddRandomPersonToListOnClick()
    {
        _personList.Add(new Person(Path.GetRandomFileName(), Path.GetRandomFileName()));

        // I'm not sure the best approach to this nullable reference type warning
        // This method is extremely low frequency, so checking the null to remove the warning is negligible.
        //
        if (_listComponent is null)
            return Task.CompletedTask;

        return _listComponent.Public_StateHasChangedAsync(totalCount: _personList.Count);
    }
}
